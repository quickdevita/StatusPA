<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StatusPA</title>
  <link rel="stylesheet" href="styles.css">
  
  <!-- Link al Manifest -->
  <link rel="manifest" href="manifest.json">

  <!-- CSS di Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  
  <!-- Google Material Icons per il microfono -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
</head>
<body>
  <!-- Barra di ricerca -->
  <div class="search-container">
    <input id="search-input" type="text" placeholder="Cerca posto o lavoro..." aria-label="Ricerca zona">
    <button id="voice-search" aria-label="Attiva ricerca vocale">
      <span class="material-icons">mic</span>
    </button>
  </div>
  
  <!-- Contenitore per la mappa -->
  <div id="map"></div>

  <!-- Icona utente -->
  <div id="user-icon">
    <img src="img/user-icon.png" alt="Utente">
  </div>

  <!-- Menu modale utente -->
  <div id="user-menu-container" class="user-menu-container">
    <div id="user-menu" class="user-menu">
      <div class="user-menu-header">
        <h3>Il mio profilo</h3>
        <button id="close-user-menu">&times;</button>
      </div>
      <div class="user-menu-content" id="user-menu-content">
        <p>Qui verranno aggiunte funzionalit√† come la creazione del profilo.</p>
      </div>
    </div>
  </div>

  <!-- Menu modale per i dettagli sui lavori -->
  <div id="modal-container" class="modal-container">
    <div id="modal" class="modal">
      <div class="modal-header">
        <div class="modal-handle"></div>
      </div>
      <div class="modal-content">
        <h2 id="modal-title"></h2>
        <p id="modal-info"></p>
      </div>
      <button id="close-modal">Chiudi</button>
    </div>
  </div>

  <!-- Modulo di registrazione (incluso nel menu modale) -->
  <div id="profile-creation-container" style="display: none;">
    <h2>Crea il tuo profilo</h2>
    <form id="profile-creation-form">
      <label for="username">Nome utente</label>
      <input type="text" id="username" name="username" required placeholder="Inserisci nome utente">
      
      <label for="password">Password</label>
      <input type="password" id="password" name="password" required placeholder="Inserisci password">
      
      <label for="confirm-password">Conferma password</label>
      <input type="password" id="confirm-password" name="confirm-password" required placeholder="Conferma password">
      
      <div id="error-message" style="color: red; display: none;"></div>
      
      <button type="submit">Registrati</button>
    </form>
  </div>

  <!-- JS di Leaflet -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="script.js"></script>
  
  <!-- Gestione del prompt di installazione PWA -->
  <script>
    let deferredPrompt;
    const installButton = document.createElement('button');
    installButton.textContent = 'Installa';

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      document.body.appendChild(installButton);

      installButton.addEventListener('click', () => {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          console.log(choiceResult.outcome === 'accepted' ? 'PWA installata!' : 'PWA non installata.');
          deferredPrompt = null;
        });
      });
    });
  </script>

  <!-- Registrazione del Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js')
        .then(reg => console.log('Service Worker registrato:', reg))
        .catch(err => console.log('Errore Service Worker:', err));
    }
  </script>

  <!-- Gestione del profilo -->
  <script>
    const profileCreationContainer = document.getElementById("profile-creation-container");
    const userMenuContent = document.getElementById("user-menu-content");
    const userMenuTitle = document.querySelector(".user-menu-header h3");
    const profileInfo = document.createElement("p");
    userMenuContent.appendChild(profileInfo);

    function openProfileCreation() {
      profileCreationContainer.style.display = "block";
      userMenuContent.style.display = "none";
      userMenuTitle.textContent = "Crea Profilo";
    }

    function closeProfileCreation() {
      profileCreationContainer.style.display = "none";
      userMenuContent.style.display = "block";
      userMenuTitle.textContent = "Il mio profilo";
    }

    const profileCreationForm = document.getElementById("profile-creation-form");
    const errorMessage = document.getElementById("error-message");

    profileCreationForm.addEventListener("submit", function(event) {
      event.preventDefault();

      const username = document.getElementById("username").value;
      const password = document.getElementById("password").value;
      const confirmPassword = document.getElementById("confirm-password").value;

      if (password.length < 4) {
        errorMessage.textContent = "La password deve essere lunga almeno 4 caratteri.";
        errorMessage.style.display = "block";
        return;
      }

      if (password !== confirmPassword) {
        errorMessage.textContent = "Le password non corrispondono.";
        errorMessage.style.display = "block";
        return;
      }

      localStorage.setItem("username", username);
      localStorage.setItem("password", password);

      closeProfileCreation();
      profileInfo.textContent = "Profilo creato con successo!";
    });

    function checkIfRegistered() {
      if (localStorage.getItem("username")) {
        profileInfo.textContent = "Gestisci il tuo profilo";
        const manageProfileButton = document.createElement("button");
        manageProfileButton.textContent = "Modifica Profilo";
        manageProfileButton.addEventListener("click", () => {
          openProfileCreation(); 
        });
        userMenuContent.appendChild(manageProfileButton);

        const deleteProfileButton = document.createElement("button");
        deleteProfileButton.textContent = "Elimina Profilo";
        deleteProfileButton.addEventListener("click", () => {
          localStorage.removeItem("username");
          localStorage.removeItem("password");
          checkIfRegistered(); 
        });
        userMenuContent.appendChild(deleteProfileButton);
      } else {
        profileInfo.textContent = "Crea il tuo profilo";
        const createProfileButton = document.createElement("button");
        createProfileButton.textContent = "Registrati";
        createProfileButton.addEventListener("click", openProfileCreation);
        userMenuContent.appendChild(createProfileButton);
      }
    }

    document.getElementById("user-icon").addEventListener("click", () => {
      checkIfRegistered();
    });
  </script>
</body>
</html>
